# Vulnerability Scanning Examples

Complete end-to-end vulnerability scanning workflows. These examples show real CVE detection in Docker images.

## Examples

### 1. Comprehensive Workflow
**File:** `docker_vulnerability_scan.py`

Complete vulnerability scanning workflow with multiple examples.

```bash
python docker_vulnerability_scan.py
```

**Features:**
- 6 different scanning scenarios
- Image comparison
- Severity filtering
- Continuous monitoring simulation
- JSON report generation

**Time:** ~10 minutes (runs all 6 examples)

**Examples included:**
1. Basic scan
2. Scan with CVE matching
3. Generate detailed report
4. Compare two images
5. Filter by severity
6. Continuous monitoring

---

### 2. Scan Vulnerable Image (Recommended!)
**File:** `scan_vulnerable_image.py`

Scan Ubuntu 18.04 to see real vulnerability findings.

```bash
python scan_vulnerable_image.py
```

**Features:**
- Targets older Ubuntu with known CVEs
- Fetches 120 days of CVE data
- Broad detection (confidence 0.6)
- Generates both JSON and text reports
- Shows severity breakdown

**Time:** ~5 minutes

**Expected output:**
- Multiple vulnerable packages detected
- Real CVE findings with descriptions
- Severity breakdown (CRITICAL, HIGH, MEDIUM, LOW)

---

### 3. Demo with Real Findings
**File:** `demo_with_findings.py`

Scan Ubuntu 14.04 for maximum vulnerability detection.

```bash
python demo_with_findings.py
```

**Features:**
- Scans very old Ubuntu (14.04)
- Guaranteed to find vulnerabilities
- Detailed CVE information
- Match confidence scoring
- No false positives (improved algorithm)

**Time:** ~3 minutes

**Sample output:**
```
✓ Found 9 vulnerable packages
✓ Total vulnerabilities detected: 15

Severity Breakdown:
  HIGH    : 10
  MEDIUM  :  3
  LOW     :  2
```

---

### 4. Quick Demo
**File:** `quick_vulnerability_demo.py`

Quick demonstration avoiding NVD rate limits.

```bash
python quick_vulnerability_demo.py
```

**Features:**
- Limited CVE set (fast)
- Focused on key packages (bash, gzip, tar)
- Avoids rate limiting issues
- Good for testing without API key

**Time:** ~2 minutes

---

## Recommended Workflow

### First Time Users

1. **Start with Quick Demo** (no API key needed):
   ```bash
   python quick_vulnerability_demo.py
   ```

2. **Try Full Scan** on older image:
   ```bash
   python demo_with_findings.py
   ```

3. **Explore Workflows**:
   ```bash
   python docker_vulnerability_scan.py
   ```

### With NVD API Key

1. **Set up API key** in `.env`:
   ```bash
   echo "NVD_API_KEY=your_key_here" >> ../../.env
   ```

2. **Build comprehensive database**:
   ```bash
   threat-radar cve update --days 365
   ```

3. **Run comprehensive scan**:
   ```bash
   python scan_vulnerable_image.py
   ```

## Understanding Results

### Confidence Scores

- **1.00 (100%)**: Exact name + version match
- **0.90 (90%)**: Known package variant (e.g., openssl ↔ libssl)
- **0.80 (80%)**: Fuzzy name match + version match
- **0.70 (70%)**: Good match with some uncertainty
- **0.60 (60%)**: Lower confidence (may need verification)

### Match Reasons

- **"exact name match"**: Package name exactly matches CPE
- **"strong name match"**: Known package mapping (NAME_MAPPINGS)
- **"fuzzy name match"**: Algorithmic similarity (may need review)

### Severity Levels

- **CRITICAL (9.0-10.0)**: Immediate action required
- **HIGH (7.0-8.9)**: High priority
- **MEDIUM (4.0-6.9)**: Medium priority
- **LOW (0.1-3.9)**: Low priority

## Output Files

All scans generate reports in the `examples/output/` directory:

```
examples/output/
├── vulnerability_report_ubuntu_18.04.json
├── vulnerability_summary_ubuntu_18.04.txt
├── ubuntu_14.04_vulnerability_report.json
└── quick_vulnerability_demo.json
```

### JSON Report Structure

```json
{
  "scan_timestamp": "2025-10-05T16:47:52",
  "image": "ubuntu:14.04",
  "total_packages": 213,
  "vulnerable_packages": 9,
  "total_vulnerabilities": 15,
  "severity_breakdown": {
    "HIGH": 10,
    "MEDIUM": 3,
    "LOW": 2
  },
  "findings": [
    {
      "package": "bash",
      "cve_id": "CVE-2014-6271",
      "severity": "CRITICAL",
      "cvss_score": 9.8,
      "confidence": 1.0,
      "version_match": true,
      "description": "..."
    }
  ]
}
```

## Common Scanning Patterns

### Scan Production Image

```bash
# Scan your production image
threat-radar cve scan-image myapp:latest \
  --confidence 0.7 \
  --severity CRITICAL \
  -o production_scan.json

# Review findings
cat production_scan.json | jq '.findings[] | select(.severity == "CRITICAL")'
```

### Compare Versions

```python
# Compare old vs new image
images = ["myapp:v1.0", "myapp:v2.0"]

for image in images:
    # Scan each
    # Compare vulnerability counts
    # Check if issues were fixed
```

### CI/CD Integration

```bash
#!/bin/bash
# In your CI pipeline

# Update CVE database
threat-radar cve update --days 7

# Scan image
threat-radar cve scan-image $IMAGE_NAME \
  --confidence 0.7 \
  -o scan.json

# Fail build if CRITICAL vulnerabilities found
CRITICAL=$(cat scan.json | jq '.severity_breakdown.CRITICAL // 0')
if [ "$CRITICAL" -gt 0 ]; then
  echo "❌ Found $CRITICAL critical vulnerabilities"
  exit 1
fi
```

## Tips

1. **Use API Key**: Get free NVD API key to avoid rate limits
   - Without: 5 requests / 30 seconds
   - With key: 50 requests / 30 seconds

2. **Build Local Database**: Much faster than API queries
   ```bash
   threat-radar cve update --days 90
   threat-radar cve db-search --severity CRITICAL
   ```

3. **Adjust Confidence**: Balance false positives vs false negatives
   - High confidence (0.8+): Fewer false positives
   - Low confidence (0.5-0.6): More detections, needs review

4. **Review False Positives**: Check match_reason for fuzzy matches
   - Exact/strong matches: High trust
   - Fuzzy matches: May need verification

## Troubleshooting

See [../TROUBLESHOOTING.md](../TROUBLESHOOTING.md) for common issues:
- NVD rate limits
- Docker image not found
- Database locked
- No vulnerabilities detected

## Next Steps

- **[04_testing](../04_testing/)** - Validate matching accuracy
- **[MATCHING_IMPROVEMENTS.md](../../MATCHING_IMPROVEMENTS.md)** - Understand the algorithm
- **[CLI_EXAMPLES.md](../CLI_EXAMPLES.md)** - Command-line workflows
