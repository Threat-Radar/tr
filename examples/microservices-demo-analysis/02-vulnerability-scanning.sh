#!/bin/bash
# Demo: CVE Vulnerability Scanning
# Shows basic vulnerability scanning with Grype integration

set -e

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║  Demo: CVE Vulnerability Scanning                         ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""
echo "Demonstrates: threat-radar cve scan-image"
echo "Use case: Finding known vulnerabilities in container images"
echo ""

# Create output directory
mkdir -p demo-02-results

# Demo service
SERVICE="paymentservice"
IMAGE="us-central1-docker.pkg.dev/google-samples/microservices-demo/paymentservice:v0.10.3"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "FEATURE: Basic CVE Scanning"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Target: $SERVICE"
echo "Image:  $IMAGE"
echo ""
echo "Press Enter to start scan..."
read

threat-radar cve scan-image "$IMAGE" \
    -o "demo-02-results/${SERVICE}_scan.json"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "RESULTS SUMMARY"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Parse and display results
TOTAL=$(jq -r '.total_vulnerabilities' demo-02-results/${SERVICE}_scan.json)
CRITICAL=$(jq -r '.severity_counts.critical // 0' demo-02-results/${SERVICE}_scan.json)
HIGH=$(jq -r '.severity_counts.high // 0' demo-02-results/${SERVICE}_scan.json)
MEDIUM=$(jq -r '.severity_counts.medium // 0' demo-02-results/${SERVICE}_scan.json)
LOW=$(jq -r '.severity_counts.low // 0' demo-02-results/${SERVICE}_scan.json)

echo "Total Vulnerabilities: $TOTAL"
echo "  Critical: $CRITICAL"
echo "  High:     $HIGH"
echo "  Medium:   $MEDIUM"
echo "  Low:      $LOW"
echo ""

echo "Sample Critical/High Vulnerabilities:"
jq -r '.vulnerabilities[] | select(.severity=="critical" or .severity=="high") | "  • \(.id): \(.package) - \(.severity)"' demo-02-results/${SERVICE}_scan.json | head -5

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "ADVANCED OPTIONS"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "1. Severity Filtering (show only critical):"
echo "   threat-radar cve scan-image $IMAGE --severity CRITICAL"
echo ""
echo "2. Auto-save results:"
echo "   threat-radar cve scan-image $IMAGE --auto-save"
echo ""
echo "3. Cleanup after scan (remove image):"
echo "   threat-radar cve scan-image $IMAGE --cleanup"
echo ""
echo "4. Only show vulnerabilities with fixes:"
echo "   threat-radar cve scan-image $IMAGE --only-fixed"
echo ""
echo "5. Fail on severity (for CI/CD):"
echo "   threat-radar cve scan-image $IMAGE --fail-on HIGH"
echo ""

echo "Results saved to: demo-02-results/${SERVICE}_scan.json"
echo ""
echo "✓ Demo Complete"
