# SBOM Storage Organization

## Overview

The `sbom_storage/` directory provides an organized structure for managing Software Bill of Materials (SBOMs) generated by Threat Radar.

## Directory Structure

```
sbom_storage/
├── README.md           # Documentation on storage conventions
├── docker/            # SBOMs from Docker container scans
├── local/             # SBOMs from local project scans
├── comparisons/       # SBOM comparison results
└── archives/          # Archived/historical SBOMs (auto-archived after 30 days)
```

## Automatic Organization

### Docker Container SBOMs

When you scan a Docker image, SBOMs are automatically saved to `sbom_storage/docker/` with the naming convention:

```
docker_<image-name>_<tag>_<timestamp>.<format>
```

**Examples:**
- `docker_alpine_3.18_20251006_174554.json` - CycloneDX JSON format
- `docker_alpine_3.18_20251006_174553.spdx.json` - SPDX JSON format
- `docker_alpine_3.18_20251006_174554.syft.json` - Syft native format

**Usage:**
```bash
# Auto-save to organized storage
threat-radar sbom docker alpine:3.18 --auto-save

# Or specify custom output
threat-radar sbom docker alpine:3.18 -o custom/path.json
```

### Local Project SBOMs

When scanning local directories or projects, SBOMs are saved to `sbom_storage/local/`:

```
local_<project-name>_<timestamp>.<format>
```

**Examples:**
- `local_threat-radar_20251006_174549.json`
- `local_myproject_20251006_150000.json`

**Usage:**
```bash
# Auto-save to organized storage
threat-radar sbom generate . --auto-save

# Or specify custom output
threat-radar sbom generate . -o custom/path.json
```

### Comparison Results

SBOM comparisons are saved to `sbom_storage/comparisons/`:

```
compare_<name1>_vs_<name2>_<timestamp>.<format>
```

**Examples:**
- `compare_alpine-3.17_vs_alpine-3.18_20251006_174552.json`
- `compare_v1.0_vs_v2.0_20251002_150000.json`

**Usage:**
```bash
threat-radar sbom compare sbom1.json sbom2.json
```

## Listing Stored SBOMs

View all stored SBOMs organized by category:

```bash
# List all SBOMs
threat-radar sbom list

# List only Docker SBOMs
threat-radar sbom list --category docker

# List only local project SBOMs
threat-radar sbom list --category local

# List only comparisons
threat-radar sbom list --category comparisons

# Limit results
threat-radar sbom list --limit 10
```

**Example output:**
```
Stored SBOMs (docker)
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ Filename                       ┃ Category ┃ Size     ┃ Modified         ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ docker_alpine_3.18_20251006…   │ docker   │ 160.2 KB │ 2025-10-06 17:45 │
│ docker_alpine_3.18_20251006…   │ docker   │ 115.8 KB │ 2025-10-06 17:45 │
│ docker_alpine_3.17_20251006…   │ docker   │ 46.3 KB  │ 2025-10-06 17:45 │
└────────────────────────────────┴──────────┴──────────┴──────────────────┘
Total: 3 SBOM(s)
```

## Supported SBOM Formats

Multiple formats can be stored with appropriate file extensions:

| Format          | Extension      | Description                    |
|-----------------|----------------|--------------------------------|
| CycloneDX JSON  | `.json`        | Default, widely supported      |
| CycloneDX XML   | `.xml`         | XML variant of CycloneDX       |
| SPDX JSON       | `.spdx.json`   | SPDX standard in JSON          |
| SPDX Tag-Value  | `.spdx`        | SPDX text format               |
| Syft JSON       | `.syft.json`   | Syft's native format           |

## Programmatic Usage

### Python API

```python
from threat_radar.utils.sbom_storage import (
    get_docker_sbom_path,
    get_local_sbom_path,
    get_comparison_path,
    ensure_storage_directories,
    list_stored_sboms
)

# Ensure directories exist
ensure_storage_directories()

# Get organized path for Docker SBOM
path = get_docker_sbom_path("alpine", "3.18", format="json")
# Returns: sbom_storage/docker/docker_alpine_3.18_<timestamp>.json

# Get path for local project SBOM
path = get_local_sbom_path("my-project", format="spdx.json")
# Returns: sbom_storage/local/local_my-project_<timestamp>.spdx.json

# Get path for comparison
path = get_comparison_path("v1.0", "v2.0", format="json")
# Returns: sbom_storage/comparisons/compare_v1.0_vs_v2.0_<timestamp>.json

# List stored SBOMs
sboms = list_stored_sboms(category="docker")
for sbom_path in sboms:
    print(sbom_path)
```

### Example Script

See `examples/02_advanced/syft_sbom_example.py` for comprehensive examples using the organized storage:

```python
from threat_radar.core.syft_integration import SyftClient, SBOMFormat
from threat_radar.utils.sbom_storage import get_docker_sbom_path
from threat_radar.utils.sbom_utils import save_sbom

client = SyftClient()

# Generate SBOM
sbom = client.scan_docker_image("alpine:3.18", output_format=SBOMFormat.CYCLONEDX_JSON)

# Save to organized storage
output_path = get_docker_sbom_path("alpine", "3.18", format="json")
save_sbom(sbom, output_path)
print(f"SBOM saved to {output_path}")
```

## Retention and Archiving

- **Current SBOMs**: Active SBOMs in `docker/` and `local/` directories
- **Historical SBOMs**: Older than 30 days are automatically moved to `archives/`
- **Comparisons**: Kept for 90 days, then deleted
- **Manual archiving**: Use the archiving utility if needed

## Benefits of Organization

1. **Clear Categorization**: Docker vs local vs comparisons
2. **Timestamped Names**: Easy to track when SBOMs were generated
3. **Multiple Formats**: Store different SBOM formats side-by-side
4. **Version Tracking**: Compare SBOMs across different versions
5. **Easy Discovery**: Use `sbom list` to find what you need
6. **Automated Cleanup**: Old SBOMs archived automatically

## Best Practices

1. **Use `--auto-save`** for automatic organization
2. **Keep meaningful project names** for local scans
3. **Use comparisons** to track dependency changes between versions
4. **Regularly review** stored SBOMs with `threat-radar sbom list`
5. **Export to CSV/requirements.txt** for reporting: `threat-radar sbom export`
